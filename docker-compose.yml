
# NOTE: If you change DB_ROOT_PASSWORD or DB_NAME while the db_data volume exists,
# run `docker compose down -v` to remove the volume and allow MariaDB to re-initialize.
services:
  database:
    build:
      context: ..
      dockerfile: DB/Dockerfile
    image: blackmine57/pupero-database:latest
    container_name: pupero-database
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-change_this_password}
      MYSQL_DATABASE: ${DB_NAME:-pupero_auth}
      MYSQL_ROOT_HOST: '%'
    #ports:
      #- "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -uroot -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 60s

  login:
    image: blackmine57/pupero-login:latest
    container_name: pupero-login
    depends_on:
      database:
        condition: service_healthy
    environment:
      DATABASE_URL: mariadb+mariadbconnector://root:${DB_ROOT_PASSWORD:-change_this_password}@pupero-database:3306/${DB_NAME:-pupero_auth}
      LOGIN_PORT: 8001
      MONERO_SERVICE_URL: pupero-api-manager
      MATRIX_ENABLED: ${MATRIX_ENABLED:-1}
      MATRIX_HS_URL: http://pupero-matrix-synapse:8008
      MATRIX_SERVER_NAME: Pupero
      MATRIX_USER_PREFIX: ${MATRIX_USER_PREFIX:-u}
      MATRIX_DEFAULT_PASSWORD_SECRET: ${MATRIX_DEFAULT_PASSWORD_SECRET:-change-me}
      MATRIX_ADMIN_SECRET: ${MATRIX_ADMIN_SECRET:-dev-shared-secret-change-me}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-43200}
      JWT_REFRESH_TOKEN_EXPIRE_MINUTES: ${JWT_REFRESH_TOKEN_EXPIRE_MINUTES:-129600}
      REMEMBER_ME_DAYS: ${REMEMBER_ME_DAYS:-30}
      LOG_FILE: /var/log/pupero/login.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8001:8001"

  offers:
    image: blackmine57/pupero-offers:latest
    container_name: pupero-offers
    depends_on:
      database:
        condition: service_healthy
    environment:
      DATABASE_URL: mariadb+mariadbconnector://root:${DB_ROOT_PASSWORD:-change_this_password}@pupero-database:3306/${DB_NAME:-pupero_auth}
      OFFERS_PORT: 8002
      LOG_FILE: /var/log/pupero/offers.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8002:8002"

  transactions:
    image: blackmine57/pupero-transactions:latest
    container_name: pupero-transactions
    depends_on:
      database:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      DATABASE_URL: mariadb+mariadbconnector://root:${DB_ROOT_PASSWORD:-change_this_password}@pupero-database:3306/${DB_NAME:-pupero_auth}
      TRANSACTIONS_PORT: 8003
      MONERO_SERVICE_URL: pupero-api-manager
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-pupero}:${RABBITMQ_PASSWORD:-pupero}@pupero-rabbitmq:5672/%2F
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE:-monero.transactions}
      LOG_FILE: /var/log/pupero/transactions.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8003:8003"

  api-manager:
    image: blackmine57/pupero-api-manager:latest
    container_name: pupero-api-manager
    depends_on:
      - login
      - offers
      - transactions
      - monero
    environment:
      API_MANAGER_PORT: 8000
      LOGIN_SERVICE_URL: pupero-login
      OFFERS_SERVICE_URL: pupero-offers
      TRANSACTIONS_SERVICE_URL: pupero-transactions
      MONERO_SERVICE_URL: pupero-WalletManager
      LOG_FILE: /var/log/pupero/api-manager.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8000:8000"

  admin:
    build:
      dockerfile: Admin/Dockerfile
    image: blackmine57/pupero-admin:latest
    container_name: pupero-admin
    depends_on:
      - api-manager
      - monero
      - transactions
    environment:
      ADMIN_PORT: 8010
      TRANSACTIONS_SERVICE_URL: pupero-api-manager
      MONERO_SERVICE_URL: pupero-api-manager
      LOG_FILE: /var/log/pupero/admin.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8010:8010"

  moderation:
    build:
      context: ..
      dockerfile: Pupero-Moderation/Dockerfile
    image: blackmine57/pupero-moderation:latest
    container_name: pupero-moderation
    depends_on:
      database:
        condition: service_healthy
      login:
        condition: service_started
      matrix-synapse:
        condition: service_healthy
    environment:
      DATABASE_URL: mariadb+mariadbconnector://root:${DB_ROOT_PASSWORD:-change_this_password}@pupero-database:3306/${DB_NAME:-pupero_auth}
      MODERATION_PORT: 8020
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-your-secret-key-here}
      LOGIN_SERVICE_URL: http://pupero-login:8001
      OFFERS_SERVICE_URL: http://pupero-offers:8002
      WALLET_SERVICE_URL: http://pupero-WalletManager:8004
      TRANSACTIONS_SERVICE_URL: http://pupero-transactions:8003
      MATRIX_HS_URL: http://pupero-matrix-synapse:8008
      MATRIX_ADMIN_SECRET: ${MATRIX_ADMIN_SECRET:-dev-shared-secret-change-me}
      MATRIX_SERVER_NAME: ${MATRIX_SERVER_NAME:-Pupero}
      LOG_FILE: /var/log/pupero/moderation.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8020:8020"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8020/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 10s

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: pupero-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-pupero}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-pupero}
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 20

  monerod:
    image: blackmine57/pupero-monerod
    container_name: pupero-monerod
    # Optional build if you want compose to build it automatically
    # build:
    #   context: ..
    #   dockerfile: Pupero-monerod/Containerfile
    volumes:
      - ${PUPERO_BLOCKCHAIN_DIR:-.bitmonero}:/root/.bitmonero:z
    environment:
      # Easily change network/extra args with MONEROD_ARGS; default to --testnet
      MONEROD_ARGS: ${MONEROD_ARGS:---testnet}
      MONEROD_P2P_PORT: ${MONEROD_P2P_PORT:-28080}
      MONEROD_RPC_PORT: ${MONEROD_RPC_PORT:-28081}
    command: ${MONEROD_ARGS:---testnet} --non-interactive --data-dir=/root/.bitmonero --rpc-bind-ip=0.0.0.0 --rpc-bind-port=${MONEROD_RPC_PORT:-28081} --confirm-external-bind --prune-blockchain
    ports:
      - "${MONEROD_P2P_PORT:-28080}:28080"
      - "${MONEROD_RPC_PORT:-28081}:28081"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${MONEROD_RPC_PORT:-28081}/get_info || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
    networks:
      default:
        aliases:
          - monero-testnet

  wallet-rpc:
    image: blackmine57/pupero-monerod:latest
    container_name: pupero-wallet-rpc
    depends_on:
      monerod:
        condition: service_healthy
    entrypoint: ["monero-wallet-rpc"]
    command:
      - "--testnet"
      - "--rpc-bind-port=18083"
      - "--rpc-bind-ip=0.0.0.0"
      - "--confirm-external-bind"
      - "--wallet-file=/monero/wallets/Pupero-Wallet"
      - "--password=vm"
      - "--log-level=4"
      - "--rpc-login=pup:pup"
      - "--daemon-address=monero-testnet:${MONEROD_RPC_PORT:-28081}"
      - "--trusted-daemon"
    volumes:
      - ${PUPERO_WALLETS_DIR:-./wallets}:/monero/wallets:z
    ports:
      - "${WALLET_RPC_PORT:-18083}:${WALLET_RPC_PORT:-18083}"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- --method=POST --header='Content-Type: application/json' --body-data='{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"get_version\"}' --auth-no-challenge --user=pup --password=pup http://127.0.0.1:${WALLET_RPC_PORT:-18083}/json_rpc >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 10s
    restart: unless-stopped

  monero:
    image: blackmine57/pupero-walletmanager:latest
    container_name: pupero-WalletManager
    depends_on:
      database:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      wallet-rpc:
        condition: service_healthy
    environment:
      DATABASE_URL: mariadb+mariadbconnector://root:${DB_ROOT_PASSWORD:-change_this_password}@pupero-database:3306/${DB_NAME:-pupero_auth}
      MONERO_RPC_URL: ${MONERO_RPC_URL:-http://pupero-wallet-rpc:18083}
      MONERO_RPC_USER: ${MONERO_RPC_USER:-pup}
      MONERO_RPC_PASSWORD: ${MONERO_RPC_PASSWORD:-pup}
      MONERO_RPC_AUTH_SCHEME: ${MONERO_RPC_AUTH_SCHEME:-digest}
      MONERO_WALLET_MANAGER_PORT: 8004
      RABBITMQ_URL: amqp://${RABBITMQ_USER:-pupero}:${RABBITMQ_PASSWORD:-pupero}@pupero-rabbitmq:5672/%2F
      RABBITMQ_QUEUE: ${RABBITMQ_QUEUE:-monero.transactions}
      RABBITMQ_POLL_INTERVAL_SECONDS: ${RABBITMQ_POLL_INTERVAL_SECONDS:-1800}
      LOG_FILE: /var/log/pupero/monero.log
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "8004:8004"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8004/healthz >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 10s

  flask:
    build:
      context: ..
      dockerfile: Pupero-LoginFrontEnd/Dockerfile
    image: blackmine57/pupero-flask:latest
    container_name: pupero-flask
    depends_on:
      - api-manager
    environment:
      PORT: 5000
      BACKEND_URL: pupero-api-manager
      OFFERS_SERVICE_URL: pupero-api-manager
      TRANSACTIONS_SERVICE_URL: pupero-api-manager
      MATRIX_HS_URL_BACKEND: http://pupero-matrix-synapse:8008
      MATRIX_ELEMENT_URL: /element
      MATRIX_SERVER_NAME: Pupero
      SECRET_KEY: ${FLASK_SECRET_KEY:-change_this_secret_key}
      REMEMBER_ME_DAYS: ${REMEMBER_ME_DAYS:-30}
      MATRIX_TRADE_CHANNEL_ARCHIVE_DAYS: ${MATRIX_TRADE_CHANNEL_ARCHIVE_DAYS:-7}
      LOG_FILE: /var/log/pupero/flask.log
    volumes:
      - pupero_logs:/var/log/pupero
    ports:
      - "5000:5000"

  sweeper:
    build:
      context: ..
      dockerfile: Sweeper/Dockerfile
    image: blackmine57/pupero-sweeper:latest
    container_name: pupero-sweeper
    depends_on:
      api-manager:
        condition: service_started
      monero:
        condition: service_healthy
      transactions:
        condition: service_started
    environment:
      MONERO_SERVICE_URL: pupero-WalletManager
      TRANSACTIONS_SERVICE_URL: pupero-transactions
      SWEEP_INTERVAL_SECONDS: ${SWEEP_INTERVAL_SECONDS:-1800}
      MIN_SWEEP_XMR: ${MIN_SWEEP_XMR:-0.0001}
      LOG_LEVEL: ${SWEEPER_LOG_LEVEL:-INFO}
      LOG_FILE: /var/log/pupero/sweeper.log
    volumes:
      - pupero_logs:/var/log/pupero
    restart: unless-stopped

  # Matrix stack (Synapse + Postgres + Element)
  matrix-db:
    image: postgres:16
    container_name: pupero-matrix-db
    environment:
      POSTGRES_USER: synapse
      POSTGRES_PASSWORD: synapse
      POSTGRES_DB: synapse
    volumes:
      - synapse_db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U synapse -d synapse"]
      interval: 5s
      timeout: 5s
      retries: 30

  matrix-synapse-init:
    image: matrixdotorg/synapse:latest
    container_name: pupero-matrix-init
    environment:
      SYNAPSE_SERVER_NAME: Pupero
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - synapse_data:/data
    command: ["generate"]
    restart: "no"

  matrix-synapse:
    image: matrixdotorg/synapse:latest
    container_name: pupero-matrix-synapse
    depends_on:
      matrix-db:
        condition: service_healthy
      matrix-synapse-init:
        condition: service_completed_successfully
    environment:
      SYNAPSE_SERVER_NAME: Pupero
      SYNAPSE_REPORT_STATS: "no"
    volumes:
      - synapse_data:/data
      - ../Pupero-Matrix/synapse.overrides.yaml:/data/synapse.overrides.yaml:ro,z
    command: [
      "run",
      "--config-path", "/data/homeserver.yaml",
      "--config-path", "/data/synapse.overrides.yaml"
    ]
    ports:
      - "8008:8008"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:8008/_matrix/client/versions >/dev/null 2>&1 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 60
      start_period: 120s

  matrix-element:
    image: vectorim/element-web:latest
    container_name: pupero-matrix-element
    volumes:
      - ../Pupero-Matrix/element-config.json:/app/config.json:ro,z
    expose:
      - "80"

  explore:
    image: blackmine57/explorer:latest
    build: ./onion-monero-blockchain-explorer
    container_name: pupero-explorer
    restart: unless-stopped
    volumes:
      - ${PUPERO_BLOCKCHAIN_DIR:-.bitmonero}:/home/monero/.bitmonero
    ports:
      - 8081:8081
    command: ["./xmrblocks --testnet --daemon-url=pupero-monerod:18089 --enable-json-api --enable-autorefresh-option --enable-emission-monitor --enable-pusher"]

  # --- Observability Stack (ELK + Prometheus/Grafana) ---
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.14.3
    container_name: pupero-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - cluster.routing.allocation.disk.watermark.low=90%
      - cluster.routing.allocation.disk.watermark.high=95%
      - cluster.routing.allocation.disk.watermark.flood_stage=98%
      - cluster.routing.allocation.disk.watermark.flood_stage.frozen=98%
      - cluster.routing.allocation.disk.watermark.flood_stage.frozen.max_headroom=5GB
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - esdata:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:9200/_cluster/health?wait_for_status=yellow&timeout=120s >/dev/null || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 120s

  elasticsearch-init:
    image: curlimages/curl:8.10.1
    container_name: pupero-elasticsearch-init
    depends_on:
      elasticsearch:
        condition: service_healthy
    command: >
      sh -c '
        echo "Clearing read-only blocks on Elasticsearch indices...";
        curl -s -X PUT "http://elasticsearch:9200/_all/_settings" -H "Content-Type: application/json" -d "{\"index.blocks.read_only_allow_delete\": null}" || true;
        curl -s -X PUT "http://elasticsearch:9200/_cluster/settings" -H "Content-Type: application/json" -d "{\"persistent\": {\"cluster.blocks.read_only_allow_delete\": null}}" || true;
        echo "Done clearing read-only blocks.";
      '
    restart: "no"

  logstash:
    image: docker.elastic.co/logstash/logstash:8.14.3
    container_name: pupero-logstash
    depends_on:
      elasticsearch:
        condition: service_healthy
      elasticsearch-init:
        condition: service_completed_successfully
    volumes:
      - ../Pupero-Elastic/logstash/pipeline:/usr/share/logstash/pipeline:ro
      - ../Pupero-Elastic/logstash/config/logstash.yml:/usr/share/logstash/config/logstash.yml:ro
    ports:
      - "5044:5044"
      - "9600:9600"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:9600 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  kibana:
    image: docker.elastic.co/kibana/kibana:8.14.3
    container_name: pupero-kibana
    depends_on:
      elasticsearch:
        condition: service_healthy
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
    ports:
      - "5601:5601"

  kibana-init:
    image: curlimages/curl:8.10.1
    container_name: pupero-kibana-init
    depends_on:
      kibana:
        condition: service_started
    volumes:
      - ../Pupero-Elastic/kibana/init.sh:/init.sh:ro
      - ../Pupero-Elastic/kibana/saved_objects.ndjson:/kibana/saved_objects.ndjson:ro
    entrypoint: ["/bin/sh", "/init.sh"]
    restart: "no"

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.14.3
    container_name: pupero-filebeat
    user: root
    depends_on:
      logstash:
        condition: service_healthy
    volumes:
      - ../Pupero-Elastic/filebeat/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - pupero_logs:/var/log/pupero:ro
    command: ["filebeat", "-e", "--strict.perms=false"]

  elasticsearch-exporter:
    image: quay.io/prometheuscommunity/elasticsearch-exporter:latest
    container_name: pupero-elasticsearch-exporter
    depends_on:
      elasticsearch:
        condition: service_healthy
    command:
      - "--es.uri=http://elasticsearch:9200"
      - "--es.all"
      - "--es.indices"
    ports:
      - "9114:9114"

  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: pupero-prometheus
    depends_on:
      - elasticsearch-exporter
    volumes:
      - ../Pupero-Elastic/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=15d"
      - "--storage.tsdb.path=/prometheus"
    ports:
      - "9090:9090"

  grafana:
    image: grafana/grafana:10.4.6
    container_name: pupero-grafana
    depends_on:
      - prometheus
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ../Pupero-Elastic/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ../Pupero-Elastic/grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ../Pupero-Elastic/grafana/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"

volumes:
  db_data:
  monero_wallets:
  synapse_data:
  synapse_db:
  esdata:
  grafana-data:
  # Shared volume for logs
  pupero_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/pupero

# Note: When running monero-wallet-rpc on the host machine, ensure containers can reach it.
# On Linux, host.docker.internal may not resolve by default. You can add:
#   extra_hosts:
#     - "host.docker.internal:host-gateway"
# under the 'monero' service if needed, and set MONERO_RPC_URL accordingly.
